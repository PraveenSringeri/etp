<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ProWellbeing â€” Student Support & Engagement</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --accent:#7c3aed; --accent-2:#6ee7b7;
      --muted:#64748b; --radius:12px; --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#f8fafc 0%, #eef2ff 100%);color:#0f172a}
    header.site-header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,0.9);backdrop-filter: blur(6px);box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .container{max-width:1100px;margin:0 auto;padding:20px}

    /* Navbar */
    .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#4f46e5);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    nav ul{display:flex;gap:10px;list-style:none;padding:0;margin:0}
    nav a{padding:8px 12px;border-radius:8px;text-decoration:none;color:var(--muted);font-weight:600}
    nav a:hover{background:rgba(99,102,241,0.08);color:var(--accent)}
    .actions{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600;transition:all 0.2s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#5b21b6);color:white}
    .btn.secondary{background:#f1f5f9;color:#475569}
    .btn.success{background:linear-gradient(90deg,#10b981,#059669);color:white}
    .hero{display:grid;grid-template-columns:1fr 420px;gap:22px;align-items:center;padding:34px 0}

    /* Hero card */
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(15,23,42,0.06);transition:transform 0.2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(15,23,42,0.08)}
    .kicker{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#ecfeff,#bbf7d0);font-weight:700;color:#065f46;margin-bottom:12px}
    h1{font-size:28px;margin:0 0 8px}
    h2{font-size:24px;margin:0 0 16px}
    h3{font-size:18px;margin:0 0 8px}
    p.lead{margin:0;color:var(--muted);line-height:1.5}

    /* Sections */
    .grid-3{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:16px}

    /* Study cards */
    .study-card{padding:18px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);transition:transform .25s, box-shadow .25s;cursor:pointer}
    .study-card:hover{transform:translateY(-6px);box-shadow:0 14px 30px rgba(15,23,42,0.08)}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#eff6ff;color:#1e3a8a;font-weight:700;font-size:13px}

    /* Quiz */
    .quiz-q{margin-bottom:12px}
    .option{display:block;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-bottom:8px;cursor:pointer;transition:all 0.2s ease}
    .option:hover{border-color:var(--accent);background:#f8faff}
    .option.correct{border-color:#10b981;background:#ecfdf5}
    .option.wrong{border-color:#ef4444;background:#fff1f2}

    /* Mock test timer */
    .timer{font-weight:800;color:var(--accent)}

    /* Live room */
    .live-room{display:flex;flex-direction:column;height:360px}
    .messages{flex:1;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px;border:1px solid #e2e8f0;border-radius:8px;background:#fafbfc}
    .msg{max-width:75%;padding:10px;border-radius:10px;background:#f1f5f9;word-wrap:break-word}
    .msg.you{background:linear-gradient(90deg,#e9d5ff,#ede9fe);align-self:flex-end}
    .msg.system{background:#fef3c7;align-self:center;max-width:90%;font-style:italic;text-align:center}

    /* Connection status */
    .connection-status{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600}
    .connection-status.connected{background:#d1fae5;color:#065f46}
    .connection-status.disconnected{background:#fee2e2;color:#dc2626}

    /* Chatbot widget */
    .chatbot-btn{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent),#4f46e5);color:white;padding:12px;border-radius:999px;box-shadow:0 8px 24px rgba(15,23,42,0.18);border:0;cursor:pointer;transition:all 0.2s ease;z-index:100}
    .chatbot-btn:hover{transform:scale(1.05)}
    .chatbot-panel{position:fixed;right:18px;bottom:78px;width:360px;max-width:calc(100% - 36px);background:var(--card);border-radius:12px;box-shadow:0 18px 40px rgba(15,23,42,0.14);overflow:hidden;display:flex;flex-direction:column;z-index:100}
    .chatbot-header{padding:12px;background:linear-gradient(90deg,#7c3aed,#5b21b6);color:white;font-weight:700}
    .chatbot-body{padding:12px;display:flex;flex-direction:column;gap:10px;height:300px}
    .chatbot-log{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;border:1px solid #e2e8f0;border-radius:8px;padding:8px;background:#fafbfc}
    .chatbot-input{display:flex;gap:8px;padding:8px;border-top:1px solid #eef2ff}
    .chatbot-input input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef}

    /* Dashboard Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px}
    .stat-card{padding:16px;border-radius:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;text-align:center;transition:transform 0.2s ease}
    .stat-card:hover{transform:translateY(-2px)}
    .stat-number{font-size:32px;font-weight:800;margin:8px 0}
    .stat-label{font-size:14px;opacity:0.9}

    /* Wellbeing indicator */
    .wellbeing-indicator{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:20px;background:#f0fdf4;color:#166534;font-weight:600;font-size:14px}

    /* Loading spinner */
    .loading{display:inline-block;width:16px;height:16px;border:2px solid #f3f4f6;border-top:2px solid #7c3aed;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

    /* Responsive */
    @media(max-width:880px){
      .hero{grid-template-columns:1fr}
      nav ul{display:none}
      .mobile-nav{display:block}
    }

    /* subtle entrance */
    .fade-up{animation:fadeUp .6s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

    /* Notification */
    .notification{position:fixed;top:20px;right:20px;padding:12px 16px;border-radius:8px;background:white;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;transform:translateX(120%);transition:transform 0.3s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{border-left:4px solid #10b981}
    .notification.error{border-left:4px solid #ef4444}
    .notification.info{border-left:4px solid #3b82f6}
  </style>
</head>
<body>
  <div id="notification" class="notification"></div>

  <header class="site-header">
    <div class="container nav">
      <div class="brand">
        <div class="logo">PW</div>
        <div>
          <div style="font-weight:800">ProWellbeing</div>
          <div style="font-size:12px;color:var(--muted)">Student Support & Engagement</div>
        </div>
      </div>

      <nav>
        <ul>
          <li><a href="#home">Home</a></li>
          <li><a href="#study">Study</a></li>
          <li><a href="#quiz">Quiz</a></li>
          <li><a href="#mock">Mock Test</a></li>
          <li><a href="#live">Live</a></li>
          <li><a href="#dashboard">Dashboard</a></li>
        </ul>
      </nav>

      <div class="actions">
        <span id="connectionStatus" class="connection-status disconnected">
          <span class="loading"></span> Connecting...
        </span>
        <button class="btn secondary" onclick="showSimpleDashboard()">My Progress</button>
        <button class="btn primary" onclick="quickWellbeingCheck()">Wellbeing Check</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="home" class="hero">
      <div>
        <span class="kicker">MVP Demo</span>
        <h1>Help students beat stress, stay engaged, and learn better.</h1>
        <p class="lead">ProWellbeing is a demo platform that combines quick wellbeing checks, interactive quizzes, mock tests, animated study tools, a demo chatbot, and a simulated live room â€” all in a single professional frontend you can run locally.</p>

        <div class="grid-3">
          <div class="card fade-up">
            <h3>Wellbeing-aware</h3>
            <p class="lead">Collect quick check-ins and show teachers class-level trends (backend integration available).</p>
          </div>
          <div class="card fade-up">
            <h3>Interactive</h3>
            <p class="lead">Quizzes, timed mock tests and live chat help keep students involved.</p>
          </div>
          <div class="card fade-up">
            <h3>Guided Study</h3>
            <p class="lead">Animated study cards and a pomodoro-style timer to reduce fatigue.</p>
          </div>
        </div>

        <!-- Database Features -->
        <div class="grid-3" style="margin-top:20px">
          <button class="btn primary" onclick="quickWellbeingCheck()">ðŸ“Š Quick Wellbeing Check</button>
          <button class="btn secondary" onclick="showSimpleDashboard()">ðŸ“ˆ View My Progress</button>
          <button class="btn secondary" onclick="showStudyHistory()">ðŸ“š Study History</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Quick demo</h3>
        <p style="color:var(--muted)">Open the <strong>Live</strong> panel in two browser tabs to simulate students interacting in real time. Use the Chatbot for quick help or the Quiz/Mock Test to practice.</p>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn primary" onclick="scrollToSection('quiz')">Try a Quiz</button>
          <button class="btn secondary" onclick="scrollToSection('study')">Study Mode</button>
        </div>
      </div>
    </section>

    <!-- STUDY -->
    <section id="study" style="margin-top:28px">
      <h2>Study â€” Focused learning with animations</h2>
      <div class="grid-3">
        <div class="study-card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="pill">Quick Concept</div>
              <h3>Active Recall</h3>
              <p style="color:var(--muted)">Flashcard-style prompts to strengthen memory.</p>
            </div>
            <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#fff,#f3f8ff);display:flex;align-items:center;justify-content:center">ðŸ“š</div>
          </div>
          <div style="margin-top:10px">
            <button class="btn secondary" onclick="openFlashcard('Active Recall','Try to explain the concept in your own words for 60 seconds.')">Open</button>
          </div>
        </div>

        <div class="study-card">
          <div class="pill">Animation</div>
          <h3>Pomodoro Timer</h3>
          <p style="color:var(--muted)">25 minutes focus, 5 minutes break â€” helps reduce digital fatigue.</p>
          <div style="margin-top:8px">
            <button class="btn secondary" onclick="startPomodoro(25)">Start 25m</button>
            <button class="btn secondary" onclick="startPomodoro(10)" style="margin-left:8px">Quick 10m</button>
          </div>
        </div>

        <div class="study-card">
          <div class="pill">Practice</div>
          <h3>Visual Notes</h3>
          <p style="color:var(--muted)">Animated cards make revision less stressful.</p>
          <div style="margin-top:8px">
            <button class="btn secondary" onclick="openVisual('Mind Map','Use this area to jot down a quick map of ideas.')">Open</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section id="quiz" style="margin-top:28px">
      <h2>Practice Quiz</h2>
      <div class="card">
        <div id="quizArea"></div>
      </div>
    </section>

    <!-- MOCK -->
    <section id="mock" style="margin-top:28px">
      <h2>Mock Test (Timed)</h2>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>Time left: <span class="timer" id="mockTimer">05:00</span></div>
          <div><button class="btn primary" id="startMock">Start Mock Test (5 min)</button></div>
        </div>
        <div id="mockArea" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- LIVE -->
    <section id="live" style="margin-top:28px">
      <h2>Live Room â€” Real-time Chat</h2>
      <div class="card live-room">
        <div class="messages" id="liveMessages">
          <div class="msg system">Welcome to the Live Room! Start chatting with other students.</div>
        </div>
        <div style="display:flex;gap:8px;padding-top:8px">
          <input id="liveInput" placeholder="Type your message..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
          <button class="btn primary" id="liveSend">Send</button>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" style="margin-top:28px">
      <h2>My Learning Dashboard</h2>
      <div class="card">
        <p class="lead" style="color:var(--muted)">Track your progress, study habits, and wellbeing over time.</p>
        
        <div class="stats-grid" id="dashboardStats">
          <div class="stat-card">
            <div class="stat-label">Quizzes Completed</div>
            <div class="stat-number">0</div>
            <div class="stat-label">Loading...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average Stress Level</div>
            <div class="stat-number">0</div>
            <div class="stat-label">/10 (lower is better)</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Study Time</div>
            <div class="stat-number">0</div>
            <div class="stat-label">minutes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Wellbeing Checks</div>
            <div class="stat-number">0</div>
            <div class="stat-label">completed</div>
          </div>
        </div>

        <div style="margin-top:20px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="loadDashboardStats()">Refresh Stats</button>
          <button class="btn secondary" onclick="showStudyHistory()">View Study History</button>
          <button class="btn secondary" onclick="showWellbeingHistory()">Wellbeing History</button>
          <button class="btn success" onclick="quickWellbeingCheck()">New Wellbeing Check</button>
        </div>

        <div id="dashboardContent" style="margin-top:20px">
          <!-- Additional content will be loaded here -->
        </div>
      </div>
    </section>

    <footer style="margin:28px 0;color:var(--muted);text-align:center">
      ProWellbeing â€” Demo UI â€¢ SQLite Database Backend â€¢ All data saved locally
      <br>
      <small>Open multiple browser tabs to test the live room functionality</small>
    </footer>
  </main>

  <!-- Chatbot floating -->
  <button class="chatbot-btn" id="chatToggle">ðŸ’¬ Chat</button>
  <div class="chatbot-panel" id="chatPanel" style="display:none">
    <div class="chatbot-header">Study Assistant</div>
    <div class="chatbot-body">
      <div class="chatbot-log" id="chatLog"></div>
      <div class="chatbot-input">
        <input id="chatMsg" placeholder="Type a question..." />
        <button class="btn primary" id="chatSend">Send</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helper: smooth scroll
    function scrollToSection(id){
        document.getElementById(id).scrollIntoView({behavior:'smooth',block:'start'});
    }

    // ---------- Notification system
    function showNotification(message, type = 'info', duration = 3000) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, duration);
    }

    // ---------- Flashcard & Visual modal (simple alerts for demo)
    function openFlashcard(title, text){
        showNotification(`Opening: ${title}`, 'info');
        setTimeout(() => {
            alert(title + "\n\n" + text);
        }, 100);
    }
    
    function openVisual(title, text){
        showNotification(`Opening: ${title}`, 'info');
        setTimeout(() => {
            alert(title + "\n\n" + text);
        }, 100);
    }

    // ---------- Database functions with error handling
    async function saveQuizResult(score, total, quizType = 'mock-test') {
        try {
            const response = await fetch('/api/quiz-results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    studentName: localName(),
                    score: score,
                    total: total,
                    quizType: quizType
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Saved to database:', data);
            showNotification('Quiz result saved successfully!', 'success');
            return data;
        } catch (error) {
            console.error('Error saving to database:', error);
            // Fallback to localStorage
            const key = `quiz-${Date.now()}`;
            localStorage.setItem(key, JSON.stringify({
                studentName: localName(),
                score: score,
                total: total,
                quizType: quizType,
                timestamp: new Date().toISOString()
            }));
            showNotification('Saved locally (offline mode)', 'info');
            return { message: 'Saved locally (offline mode)' };
        }
    }

    async function saveWellbeingCheck(mood, stressLevel, message = '') {
        try {
            const response = await fetch('/api/wellbeing-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    studentName: localName(),
                    mood: mood,
                    stressLevel: stressLevel,
                    message: message
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Wellbeing check saved:', data);
            showNotification('Wellbeing check saved!', 'success');
            return data;
        } catch (error) {
            console.error('Error saving wellbeing check:', error);
            // Fallback to localStorage
            const key = `wellbeing-${Date.now()}`;
            localStorage.setItem(key, JSON.stringify({
                studentName: localName(),
                mood: mood,
                stressLevel: stressLevel,
                message: message,
                timestamp: new Date().toISOString()
            }));
            showNotification('Saved locally (offline mode)', 'info');
            return { message: 'Saved locally (offline mode)' };
        }
    }

    async function saveStudySession(sessionType, durationMinutes) {
        try {
            const response = await fetch('/api/study-sessions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    studentName: localName(),
                    sessionType: sessionType,
                    durationMinutes: durationMinutes
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Study session saved:', data);
            showNotification('Study session saved!', 'success');
            return data;
        } catch (error) {
            console.error('Error saving study session:', error);
            // Fallback to localStorage
            const key = `study-${Date.now()}`;
            localStorage.setItem(key, JSON.stringify({
                studentName: localName(),
                sessionType: sessionType,
                durationMinutes: durationMinutes,
                timestamp: new Date().toISOString()
            }));
            showNotification('Saved locally (offline mode)', 'info');
            return { message: 'Saved locally (offline mode)' };
        }
    }

    async function getDashboardStats() {
        try {
            const response = await fetch('/api/dashboard-stats');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const stats = await response.json();
            console.log('Dashboard stats:', stats);
            return stats;
        } catch (error) {
            console.error('Error getting stats:', error);
            // Calculate stats from localStorage as fallback
            return calculateLocalStats();
        }
    }

    function calculateLocalStats() {
        const stats = {
            totalQuizzes: 0,
            averageStress: 0,
            totalStudyMinutes: 0,
            totalWellbeingChecks: 0
        };
        
        // Count localStorage items
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('quiz-')) stats.totalQuizzes++;
            if (key.startsWith('wellbeing-')) stats.totalWellbeingChecks++;
            if (key.startsWith('study-')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    stats.totalStudyMinutes += data.durationMinutes || 0;
                } catch (e) {}
            }
        }
        
        return stats;
    }

    async function getQuizResults() {
        try {
            const response = await fetch('/api/quiz-results');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const results = await response.json();
            return results;
        } catch (error) {
            console.error('Error getting quiz results:', error);
            // Get from localStorage as fallback
            return getLocalQuizResults();
        }
    }

    function getLocalQuizResults() {
        const results = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('quiz-')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    results.push(data);
                } catch (e) {}
            }
        }
        return results.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    }

    // ---------- Pomodoro with database saving
    let pomTimer;
    function startPomodoro(minutes=25){
        clearInterval(pomTimer); 
        let seconds=minutes*60;
        
        showNotification(`Pomodoro started for ${minutes} minutes. Focus time! ðŸŽ¯`, 'info');
        
        pomTimer = setInterval(()=>{
            seconds--; 
            if(seconds<=0){
                clearInterval(pomTimer); 
                
                // Save study session to database
                saveStudySession('pomodoro', minutes);
                
                showNotification(`ðŸŽ‰ Pomodoro complete â€” ${minutes} minutes studied! Take a 5 minute break.`, 'success');
            }
        }, 1000);
    }

    // ---------- Quiz: questions (customize easily)
    const quizQuestions = [
      {
          q:'Which technique helps strengthen memory by self-recall?', 
          options:['Rereading','Active recall','Highlighting','Watching videos'], 
          a:1
      },
      {
          q:'A short focused study slot followed by a break is known as?', 
          options:['Pomodoro','Flashcards','Mind map','Project-based'], 
          a:0
      },
      {
          q:'What is the recommended study duration before taking a break?', 
          options:['60 minutes','90 minutes','25-30 minutes','10 minutes'], 
          a:2
      }
    ];

    function renderQuiz(){
      const area = document.getElementById('quizArea'); 
      area.innerHTML='<p class="lead">Answer these questions to test your knowledge. Click on your answer choice.</p>';
      
      quizQuestions.forEach((qq, idx)=>{
        const card = document.createElement('div'); 
        card.className='card'; 
        card.style.marginBottom='16px';
        
        const h = document.createElement('h3'); 
        h.textContent = 'Q'+(idx+1)+': '+qq.q; 
        card.appendChild(h);
        
        qq.options.forEach((opt,i)=>{
          const op = document.createElement('div'); 
          op.className='option'; 
          op.textContent = opt; 
          op.onclick = async ()=>{
            // Disable all options after selection
            const options = card.querySelectorAll('.option');
            options.forEach(opt => opt.style.pointerEvents = 'none');
            
            if(i===qq.a){ 
                op.classList.add('correct'); 
                // Save quiz result
                await saveQuizResult(1, 1, 'practice-quiz');
                showNotification('Correct! âœ… Score saved to your progress.', 'success');
            } else { 
                op.classList.add('wrong'); 
                // Highlight correct answer
                options[qq.a].classList.add('correct');
                showNotification(`Incorrect. The right answer is: ${qq.options[qq.a]}`, 'error');
            }
          };
          card.appendChild(op);
        });
        area.appendChild(card);
      });
    }

    // ---------- Mock Test: timed
    const mockQuestions = [
      {
          q:'What is the most effective single study technique according to research?', 
          options:['Highlighting','Active recall','Passive reading','Listening to lectures'], 
          a:1
      },
      {
          q:'What should you do after feeling fatigued during study?', 
          options:['Keep studying','Take a short break','Skip learning','Drink coffee'], 
          a:1
      },
      {
          q:'Which of these improves long-term retention?', 
          options:['Cramming','Spaced repetition','Multitasking','Studying in noisy environments'], 
          a:1
      }
    ];
    
    let mockState = {running:false, timeLeft:0, index:0, score:0, timer:null};
    const mockTimerEl = document.getElementById('mockTimer');

    document.getElementById('startMock').addEventListener('click', ()=>{
      if (!mockState.running) {
          startMock(5); // 5 minutes for demo
      }
    });

    function startMock(minutes=5){
      mockState = {running:true, timeLeft:minutes*60, index:0, score:0, timer:null};
      document.getElementById('startMock').textContent = 'Test Running...';
      document.getElementById('startMock').disabled = true;
      
      renderMock();
      
      mockState.timer = setInterval(()=>{
        if(!mockState.running){ 
            clearInterval(mockState.timer); 
            return; 
        }
        mockState.timeLeft--; 
        if(mockState.timeLeft<=0){ 
            clearInterval(mockState.timer); 
            finishMock(); 
        }
        mockTimerEl.textContent = formatTime(mockState.timeLeft);
      },1000);
    }

    function finishMock(){
        mockState.running=false; 
        mockTimerEl.textContent='00:00'; 
        document.getElementById('startMock').textContent = 'Start Mock Test (5 min)';
        document.getElementById('startMock').disabled = false;
        
        // Save to database
        saveQuizResult(mockState.score, mockQuestions.length, 'mock-test');
        
        showNotification(`ðŸŽ¯ Mock test finished! Score: ${mockState.score}/${mockQuestions.length}`, 'success');
        
        // Show results
        const area = document.getElementById('mockArea');
        area.innerHTML = `
            <div class="card" style="background:linear-gradient(135deg,#a5b4fc,#818cf8);color:white;text-align:center">
                <h3>Test Complete! ðŸŽ‰</h3>
                <div style="font-size:48px;font-weight:bold;margin:10px 0">${mockState.score}/${mockQuestions.length}</div>
                <p>${mockState.score === mockQuestions.length ? 'Perfect score! Amazing! ðŸŒŸ' : 
                    mockState.score >= mockQuestions.length/2 ? 'Good job! Keep practicing! ðŸ’ª' : 
                    'Keep studying! You\'ll get better! ðŸ“š'}</p>
            </div>
        `;
    }

    function renderMock(){
      const area = document.getElementById('mockArea'); 
      area.innerHTML='';
      
      if (mockState.index >= mockQuestions.length) {
          finishMock();
          return;
      }
      
      const mq = mockQuestions[mockState.index];
      const card = document.createElement('div');
      card.className = 'card';
      
      const progress = document.createElement('div');
      progress.style.display = 'flex';
      progress.style.justifyContent = 'space-between';
      progress.style.marginBottom = '16px';
      progress.style.fontSize = '14px';
      progress.style.color = 'var(--muted)';
      progress.innerHTML = `
          <span>Question ${mockState.index + 1} of ${mockQuestions.length}</span>
          <span>Score: ${mockState.score}</span>
      `;
      card.appendChild(progress);
      
      const h = document.createElement('h3'); 
      h.textContent = mq.q; 
      card.appendChild(h);
      
      mq.options.forEach((o,i)=>{
        const b = document.createElement('button'); 
        b.className='btn secondary'; 
        b.style.display='block'; 
        b.style.marginTop='8px'; 
        b.style.width='100%';
        b.style.textAlign='left';
        b.textContent=o; 
        b.onclick = ()=>{ 
            if(i===mq.a){ 
                mockState.score++; 
                showNotification('Correct! âœ…', 'success');
            } else {
                showNotification('Incorrect âŒ', 'error');
            } 
            mockState.index++; 
            renderMock(); 
        };
        card.appendChild(b);
      });
      
      area.appendChild(card);
    }

    function formatTime(sec){ 
        const m = String(Math.floor(sec/60)).padStart(2,'0'); 
        const s = String(sec%60).padStart(2,'0'); 
        return m+':'+s; 
    }

    // ---------- Live Room: WebSocket implementation
    let liveSocket = null;
    let isLiveConnected = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function connectLiveRoom() {
        try {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}`;
            
            liveSocket = new WebSocket(wsUrl);
            
            liveSocket.onopen = () => {
                console.log('Connected to live room');
                isLiveConnected = true;
                reconnectAttempts = 0;
                updateConnectionStatus(true);
                renderLiveMessage({name: 'System', text: 'Connected to live room! Start chatting...'}, false);
            };
            
            liveSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    renderLiveMessage(data, false);
                } catch (error) {
                    console.error('Error parsing live message:', error);
                }
            };
            
            liveSocket.onclose = () => {
                console.log('Disconnected from live room');
                isLiveConnected = false;
                updateConnectionStatus(false);
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * reconnectAttempts, 10000);
                    console.log(`Reconnecting in ${delay}ms... (attempt ${reconnectAttempts})`);
                    setTimeout(connectLiveRoom, delay);
                } else {
                    renderLiveMessage({name: 'System', text: 'Unable to connect to live room. Using offline mode.'}, false);
                }
            };
            
            liveSocket.onerror = (error) => {
                console.error('Live room error:', error);
                isLiveConnected = false;
                updateConnectionStatus(false);
            };
            
        } catch (error) {
            console.error('Failed to connect to live room:', error);
            isLiveConnected = false;
            updateConnectionStatus(false);
            // Fallback to localStorage method
            setupLocalStorageFallback();
        }
    }

    function setupLocalStorageFallback() {
        console.log('Using localStorage fallback for live room');
        window.addEventListener('storage', (e) => {
            if (e.key === 'prowellbeing-live-messages') {
                try {
                    const messages = JSON.parse(e.newValue || '[]');
                    if (messages.length > 0) {
                        const latestMessage = messages[messages.length - 1];
                        renderLiveMessage(latestMessage, false);
                    }
                } catch (error) {
                    console.error('Error parsing localStorage message:', error);
                }
            }
        });
    }

    function sendLiveMessage(payload) {
        if (isLiveConnected && liveSocket && liveSocket.readyState === WebSocket.OPEN) {
            liveSocket.send(JSON.stringify(payload));
        } else {
            // Fallback to localStorage
            const messages = JSON.parse(localStorage.getItem('prowellbeing-live-messages') || '[]');
            messages.push(payload);
            localStorage.setItem('prowellbeing-live-messages', JSON.stringify(messages));
            // Trigger storage event
            window.dispatchEvent(new Event('storage'));
        }
        renderLiveMessage(payload, true);
    }

    function renderLiveMessage(payload, self) {
        const container = document.getElementById('liveMessages');
        const div = document.createElement('div');
        div.className = 'msg' + (self ? ' you' : '') + (payload.name === 'System' ? ' system' : '');
        
        const nameSpan = document.createElement('span');
        nameSpan.style.fontWeight = 'bold';
        nameSpan.textContent = payload.name + ': ';
        
        const textSpan = document.createElement('span');
        textSpan.textContent = payload.text;
        
        div.appendChild(nameSpan);
        div.appendChild(textSpan);
        container.appendChild(div);
        
        // Auto-scroll to bottom
        container.scrollTop = container.scrollHeight;
        
        // Limit messages to prevent memory issues
        const messages = container.querySelectorAll('.msg');
        if (messages.length > 100) {
            messages[0].remove();
        }
    }

    function updateConnectionStatus(connected) {
        const statusEl = document.getElementById('connectionStatus');
        if (connected) {
            statusEl.innerHTML = 'ðŸŸ¢ Connected';
            statusEl.className = 'connection-status connected';
        } else {
            statusEl.innerHTML = '<span class="loading"></span> Connecting...';
            statusEl.className = 'connection-status disconnected';
        }
    }

    // ---------- User management
    function localName(){ 
        let n = localStorage.getItem('prowell_name'); 
        if(!n){ 
            n = 'Student' + Math.floor(Math.random() * 900 + 100); 
            localStorage.setItem('prowell_name', n); 
        } 
        return n; 
    }

    // ---------- Wellbeing Check
    async function quickWellbeingCheck() {
        const mood = prompt('How are you feeling today? ðŸ˜Š\n(good/okay/stressed)');
        if (!mood) return;
        
        const stress = prompt('On a scale of 1-10, how stressed are you? ðŸ“Š');
        if (!stress) return;
        
        const stressLevel = parseInt(stress);
        if (isNaN(stressLevel) || stressLevel < 1 || stressLevel > 10) {
            alert('Please enter a valid number between 1 and 10.');
            return;
        }
        
        const message = prompt('Any comments about how you\'re feeling? (optional) ðŸ’­') || '';
        
        await saveWellbeingCheck(mood, stressLevel, message);
        
        // Show appropriate message based on stress level
        if (stressLevel >= 7) {
            showNotification('Thanks for checking in! ðŸ™ Consider taking a short break or trying some breathing exercises. Your wellbeing matters! ðŸ’š', 'info', 5000);
        } else if (stressLevel >= 4) {
            showNotification('Thanks for checking in! ðŸŒŸ Remember to take regular breaks and stay hydrated. You\'re doing great! ðŸ’ª', 'info', 4000);
        } else {
            showNotification('Thanks for checking in! ðŸŽ‰ Great to hear you\'re doing well! Keep up the good work! âœ¨', 'success', 3000);
        }
    }

    // ---------- Dashboard Functions
    async function loadDashboardStats() {
        showNotification('Loading dashboard stats...', 'info');
        const stats = await getDashboardStats();
        const statsContainer = document.getElementById('dashboardStats');
        
        if (!stats) {
            statsContainer.innerHTML = '<div class="card"><p>Unable to load stats. Make sure the server is running.</p></div>';
            showNotification('Failed to load stats', 'error');
            return;
        }

        statsContainer.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Quizzes Completed</div>
                <div class="stat-number">${stats.totalQuizzes || 0}</div>
                <div class="stat-label">total attempts</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Stress Level</div>
                <div class="stat-number">${stats.averageStress || 0}</div>
                <div class="stat-label">/10 (lower is better)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Study Time</div>
                <div class="stat-number">${stats.totalStudyMinutes || 0}</div>
                <div class="stat-label">minutes</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Wellbeing Checks</div>
                <div class="stat-number">${stats.totalWellbeingChecks || 0}</div>
                <div class="stat-label">completed</div>
            </div>
        `;
        
        showNotification('Dashboard updated!', 'success');
    }

    async function showSimpleDashboard() {
        const stats = await getDashboardStats();
        if (stats) {
            alert(`ðŸ“Š Your Learning Dashboard:\n\n` +
                  `âœ… Quizzes Completed: ${stats.totalQuizzes || 0}\n` +
                  `ðŸ˜Š Average Stress Level: ${stats.averageStress || 0}/10\n` +
                  `â±ï¸ Total Study Time: ${stats.totalStudyMinutes || 0} minutes\n` +
                  `ðŸ’š Wellbeing Checks: ${stats.totalWellbeingChecks || 0}\n\n` +
                  `Keep up the great work! ðŸŽ‰`);
        } else {
            alert('Unable to load dashboard stats. Make sure the server is running.');
        }
    }

    async function showStudyHistory() {
        const results = await getQuizResults();
        const userResults = results.filter(r => r.student_name === localName());
        
        if (userResults.length === 0) {
            alert('No study history found. Complete some quizzes or mock tests to see your progress!');
            return;
        }

        let historyText = 'ðŸ“š Your Study History:\n\n';
        userResults.slice(0, 10).forEach(result => {
            const date = new Date(result.timestamp).toLocaleDateString();
            const scorePercent = Math.round((result.score/result.total)*100);
            historyText += `ðŸ“… ${date}: ${result.quiz_type} - ${result.score}/${result.total} (${scorePercent}%)\n`;
        });

        alert(historyText);
    }

    async function showWellbeingHistory() {
        try {
            const response = await fetch(`/api/wellbeing-checks/${encodeURIComponent(localName())}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const checks = await response.json();
            
            if (checks.length === 0) {
                alert('No wellbeing checks found. Use the "Wellbeing Check" button to track your mood!');
                return;
            }

            let historyText = 'ðŸ’š Your Wellbeing History:\n\n';
            checks.slice(0, 8).forEach(check => {
                const date = new Date(check.timestamp).toLocaleDateString();
                const moodEmoji = check.mood === 'good' ? 'ðŸ˜Š' : check.mood === 'okay' ? 'ðŸ˜' : 'ðŸ˜¥';
                historyText += `ðŸ“… ${date}: ${moodEmoji} Stress ${check.stress_level}/10\n`;
                if (check.message) {
                    historyText += `   ðŸ’­ "${check.message}"\n`;
                }
            });

            alert(historyText);
        } catch (error) {
            console.error('Error loading wellbeing history:', error);
            alert('Unable to load wellbeing history. You may be offline.');
        }
    }

    // ---------- Enhanced Chatbot
    const botReplies = {
        'stress': "If you're feeling stressed, try a 3-minute breathing break: inhale 4s â€” hold 4s â€” exhale 6s. Also try breaking tasks into 10-minute chunks. Would you like to do a quick wellbeing check?",
        'study': "Active recall and spaced repetition work best. Try a short quiz after each reading session. I can save your study sessions to track progress!",
        'tired': "Short breaks, hydration, and 5 minutes of movement can help. Also consider a short nap if possible. Your Pomodoro sessions are being tracked!",
        'wellbeing': "I can help you track your wellbeing. Use the quick check-in or tell me how you're feeling.",
        'progress': "Check your learning progress! All your quiz results and study sessions are being saved.",
        'hello': "Hello! I'm your study assistant. I can help with study tips, wellbeing advice, or track your learning progress. What would you like to know?",
        'help': "I can help you with:\nâ€¢ Study techniques and timers\nâ€¢ Wellbeing and stress management\nâ€¢ Tracking your learning progress\nâ€¢ Quiz and mock test practice\nJust ask me anything!",
        'default': "I'm your study assistant. Ask about study tips, time management, wellbeing, or say 'help' for more options."
    };

    function botAnswer(text){
        const t = text.toLowerCase(); 
        if(t.includes('hello') || t.includes('hi ')) return botReplies.hello;
        if(t.includes('help')) return botReplies.help;
        if(t.includes('stress') || t.includes('anxious') || t.includes('overwhelm')) return botReplies.stress;
        if(t.includes('study')||t.includes('learn')||t.includes('progress')) return botReplies.study;
        if(t.includes('tired')||t.includes('fatigue')||t.includes('exhaust')) return botReplies.tired;
        if(t.includes('wellbeing')||t.includes('mood')||t.includes('feel')) return botReplies.wellbeing;
        return botReplies.default;
    }

    // floating chatbot
    const chatToggle = document.getElementById('chatToggle'); 
    const chatPanel = document.getElementById('chatPanel'); 
    const chatLog = document.getElementById('chatLog');
    
    chatToggle.addEventListener('click', ()=>{ 
        chatPanel.style.display = chatPanel.style.display === 'none' ? 'flex' : 'none'; 
    });
    
    document.getElementById('chatSend').addEventListener('click', sendChatMessage);
    
    function sendChatMessage(){ 
        const input = document.getElementById('chatMsg');
        const v = input.value.trim(); 
        if(!v) return; 
        
        appendChat('You', v); 
        setTimeout(()=>{ 
            const reply = botAnswer(v);
            appendChat('Assistant', reply);
            
            // Special actions based on reply
            if (reply.includes('wellbeing check')) {
                setTimeout(() => quickWellbeingCheck(), 1000);
            }
        }, 600); 
        input.value=''; 
    }

    function appendChat(who, text){ 
        const d = document.createElement('div'); 
        d.style.padding='8px'; 
        d.style.borderRadius='8px'; 
        d.style.background = who==='You' ? '#eef2ff' : '#f1f5f9'; 
        d.style.marginBottom = '4px';
        d.textContent = who+': '+text; 
        chatLog.appendChild(d); 
        chatLog.scrollTop = chatLog.scrollHeight; 
    }

    // ---------- Initial setup
    document.addEventListener('DOMContentLoaded', ()=>{ 
        // Initialize components
        renderQuiz();
        mockTimerEl.textContent='05:00';
        
        // Connect to live room
        connectLiveRoom();
        
        // Load dashboard stats on page load
        setTimeout(loadDashboardStats, 1000);
        
        // Set initial chatbot message
        setTimeout(() => {
            appendChat('Assistant', "Hello! I'm your study assistant. I can help with study tips, wellbeing advice, or track your learning progress. Try asking about 'stress' or 'study techniques'!");
        }, 1500);
        
        // Show welcome notification
        setTimeout(() => {
            showNotification(`Welcome to ProWellbeing, ${localName()}! ðŸŽ‰`, 'success', 4000);
        }, 2000);
    });

    // ---------- Event listeners for enter key
    document.getElementById('chatMsg').addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter'){
            e.preventDefault(); 
            sendChatMessage();
        } 
    });
    
    document.getElementById('liveInput').addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter'){
            e.preventDefault(); 
            document.getElementById('liveSend').click();
        } 
    });

    // Live room send button handler
    document.getElementById('liveSend').addEventListener('click', () => {
        const input = document.getElementById('liveInput');
        const text = input.value.trim();
        if (!text) return;
        
        const name = localName();
        sendLiveMessage({ name, text });
        input.value = '';
    });
  </script>
</body>
</html>